<!DOCTYPE html>
<html>
<head>
  <title>Recruiter Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  <style>
    .dashboard-section {
      margin: 20px 0;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #333;
    }
    
    .form-group .field-help {
      font-size: 0.875rem;
      color: #6c757d;
      margin-top: 4px;
      display: block;
    }
    
    input, select, textarea {
      width: 95%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-family: inherit;
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    
    button {
      background: #00aaff;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    
    button:hover {
      background: #008ecc;
    }
    
    .logout-btn {
      background: #dc3545;
    }
    
    .logout-btn:hover {
      background: #c82333;
    }
    
    .delete-btn {
      background: #dc3545;
    }
    
    .application-item {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      background: #f9f9f9;
    }
    
    .application-header {
      font-size: 1.1em;
      margin-bottom: 10px;
    }
    
    .application-details {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    
    .application-actions {
      margin-top: 10px;
    }
    
    .status {
      padding: 2px 8px;
      border-radius: 3px;
      font-weight: bold;
    }
    
    .status-applied {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-shortlisted {
      background: #d1ecf1;
      color: #0c5460;
    }
    
    .status-accepted {
      background: #d4edda;
      color: #155724;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .required::after {
      content: " *";
      color: #dc3545;
    }
    
    .job-item {
      border: 1px solid #ddd;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      background: #f8f9fa;
    }
    
    .job-meta {
      color: #6c757d;
      font-size: 0.9em;
      margin: 5px 0;
    }
    
    .branch-select {
      height: 120px;
    }
    
    .selection-help {
      background: #e7f3ff;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 0;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Welcome, Recruiter</h2>
    <a href="{{ url_for('logout') }}"><button class="logout-btn">Logout</button></a>

    <!-- Post Job -->
    <div class="dashboard-section">
      <h3>Post a Job</h3>
      <form id="postJobForm" method="POST" action="/post_job">
        <div class="form-group">
          <label for="jobTitle" class="required">Job Title</label>
          <input type="text" id="jobTitle" name="title" placeholder="e.g., Software Engineer, Data Analyst, ML Engineer" required>
        </div>

        <div class="form-group">
          <label for="jobDescription" class="required">Job Description</label>
          <textarea id="jobDescription" name="description" placeholder="Describe the role, responsibilities, and requirements..." required></textarea>
        </div>

        <div class="form-group">
          <label for="jobLocation" class="required">Job Location</label>
          <input type="text" id="jobLocation" name="location" placeholder="e.g., Bangalore, Remote, Hybrid" required>
        </div>

        <div class="form-group">
          <label for="jobSalary" class="required">Salary Package</label>
          <input type="text" id="jobSalary" name="salary" placeholder="e.g., 8 LPA, $50,000 per year" required>
        </div>

        <div class="form-group">
          <label for="jobDeadline" class="required">Application Deadline</label>
          <input type="date" id="jobDeadline" name="deadline" required>
        </div>

        <div class="form-group">
          <label for="jobEligibility" class="required">Minimum CGPA Required</label>
          <input type="number" id="jobEligibility" name="eligibility" step="0.01" min="0" max="10" placeholder="e.g., 7.5" required>
        </div>

        <div class="form-group">
          <label for="targetBranches" class="required">Target Branches</label>
          <select id="targetBranches" name="target_branches" multiple required class="branch-select">
            <option value="all">All Branches</option>
            <option value="AI & ML">AI & ML</option>
            <option value="Computer Engineering">Computer Engineering</option>
            <option value="Information Technology">Information Technology</option>
            <option value="Electronics & Telecommunication">Electronics & Telecommunication</option>
            <option value="Mechanical Engineering">Mechanical Engineering</option>
            <option value="Civil Engineering">Civil Engineering</option>
            <option value="Electrical Engineering">Electrical Engineering</option>
          </select>
          <div class="selection-help">
            <strong>How to select:</strong><br>
            • <strong>Click on branches</strong> to select them<br>
            • Hold <strong>Ctrl (Windows)</strong> or <strong>Cmd (Mac)</strong> to select multiple branches<br>
            • Select <strong>"All Branches"</strong> to make job visible to everyone
          </div>
        </div>

        <button type="submit">Post Job</button>
      </form>
    </div>

    <!-- View Applicants -->
    <div class="dashboard-section">
      <h3>Your Job Applications</h3>
      <ul class="student-list">
        <li>Loading applications...</li>
      </ul>
    </div>

    <!-- Manage Jobs -->
    <div class="dashboard-section">
      <h3>Your Posted Jobs</h3>
      <ul class="job-list">
        <li>Loading jobs...</li>
      </ul>
    </div>
  </div>

  <script>
    // Load applicants for recruiter's jobs
    function loadApplications() {
      fetch("/recruiter_applicants")
        .then(res => {
          if (!res.ok) {
            throw new Error('Network response was not ok');
          }
          return res.json();
        })
        .then(data => {
          let html = "";
          if (data.error) {
            html = `<li class="error">Error: ${data.error} - ${data.details || ''}</li>`;
          } else if (data.length === 0) {
            html = "<li>No applications yet for your jobs.</li>";
          } else {
            data.forEach(app => {
              const resumeLink = app.submitted_resume_path 
                                 ? `/download_resume/${app.submitted_resume_path}` 
                                 : '#';
              const statusClass = `status-${app.status || 'applied'}`;

              html += `<li class="application-item">
                         <div class="application-header">
                           <strong>${app.student_name || 'N/A'}</strong> 
                           (<em>${app.student_email || 'N/A'}</em>) 
                           applied for <strong>${app.job_title || 'N/A'}</strong>
                         </div>
                         <div class="application-details">
                           <strong>Student Details:</strong><br>
                           - Branch: ${app.student_branch || 'N/A'}<br>
                           - CGPA: ${app.student_cgpa || 'N/A'}<br>
                           - Phone: ${app.student_phone || 'N/A'}<br>
                           <strong>Application Details:</strong><br>
                           - Status: <span class="status ${statusClass}">${app.status || 'applied'}</span><br>
                           - Applied On: ${app.applied_date ? new Date(app.applied_date).toLocaleDateString() : 'N/A'}<br>
                           - Experience: ${app.experience_years || '0'} years<br>
                           - Availability: ${app.commitment_hours || 'N/A'} hours/day<br>
                           - Resume: <a href="${resumeLink}" target="_blank">View Resume</a>
                         </div>
                         <div class="application-actions">
                           <button onclick="updateStatus(${app.application_id}, 'shortlisted')">Shortlist</button>
                           <button onclick="updateStatus(${app.application_id}, 'accepted')">Accept</button>
                           <button onclick="updateStatus(${app.application_id}, 'rejected')">Reject</button>
                         </div>
                       </li>`;
            });
          }
          document.querySelector(".student-list").innerHTML = html;
        })
        .catch(error => {
          console.error('Error fetching recruiter applications:', error);
          document.querySelector(".student-list").innerHTML = 
            `<li class="error">Failed to load applications. Please try again.</li>`;
        });
    }

    // Update status function
    function updateStatus(appId, status){
      fetch("/update_application", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: `application_id=${appId}&status=${status}`
      })
      .then(res => {
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        alert(data.message || "Application status updated!");
        loadApplications(); // Reload applications instead of full page reload
      })
      .catch(error => {
        console.error("Error updating application status:", error);
        alert("Failed to update status: " + error.message);
      });
    }

    // Load recruiter's jobs
    function loadJobs() {
      fetch("/recruiter_jobs")
        .then(res => res.json())
        .then(data => {
          let html = "";
          if (data.length === 0) {
            html = "<li>No jobs posted yet.</li>";
          } else {
            data.forEach(job => {
              const branches = job.target_branches ? 
                (Array.isArray(job.target_branches) ? job.target_branches.join(', ') : job.target_branches) 
                : 'All Branches';
              
              html += `<li class="job-item">
                <div class="application-header">
                  <strong>${job.title}</strong>
                </div>
                <div class="job-meta">
                  <strong>Location:</strong> ${job.location} | 
                  <strong>Salary:</strong> ${job.salary} | 
                  <strong>Deadline:</strong> ${new Date(job.deadline).toLocaleDateString()}
                </div>
                <div class="job-meta">
                  <strong>Minimum CGPA:</strong> ${job.eligibility} | 
                  <strong>Target Branches:</strong> ${branches}
                </div>
                <div class="application-actions">
                  <button onclick="viewJobApplications(${job.job_id})">View Applications</button>
                  <button onclick="deleteJob(${job.job_id})" class="delete-btn">Delete Job</button>
                </div>
              </li>`;
            });
          }
          document.querySelector(".job-list").innerHTML = html;
        })
        .catch(error => {
          console.error('Error fetching recruiter jobs:', error);
          document.querySelector(".job-list").innerHTML = 
            `<li class="error">Failed to load jobs. Please try again.</li>`;
        });
    }

    // View job applications
    function viewJobApplications(jobId) {
      // Filter and show only applications for this specific job
      const applications = document.querySelectorAll('.application-item');
      let foundApplications = false;
      
      applications.forEach(app => {
        // This would need to be implemented based on your data structure
        // For now, just show a message
        app.style.display = 'none';
      });
      
      // Show a message about filtering (you would implement actual filtering)
      alert(`Showing applications for Job ID: ${jobId}. In a full implementation, this would filter the applications list.`);
      
      // Reload all applications for now
      loadApplications();
    }

    // Delete job
    function deleteJob(jobId) {
      if (confirm("Are you sure you want to delete this job? All applications for this job will also be deleted.")) {
        fetch(`/delete_job/${jobId}`, { method: "POST" })
          .then(res => res.json())
          .then(data => {
            alert(data.message);
            loadJobs(); // Reload jobs list
            loadApplications(); // Reload applications list
          })
          .catch(error => {
            console.error("Error deleting job:", error);
            alert("Failed to delete job: " + error.message);
          });
      }
    }

    // Form validation for job posting
    document.getElementById('postJobForm').addEventListener('submit', function(e) {
      const cgpa = document.getElementById('jobEligibility').value;
      const branches = document.getElementById('targetBranches');
      const selectedBranches = Array.from(branches.selectedOptions).map(option => option.value);
      
      if (cgpa < 0 || cgpa > 10) {
        alert('Please enter a valid CGPA between 0 and 10');
        e.preventDefault();
        return;
      }
      
      if (selectedBranches.length === 0) {
        alert('Please select at least one target branch');
        e.preventDefault();
        return;
      }
      
      // Simple confirmation
      if (!confirm('Proceed to post job?')) {
        e.preventDefault();
      }
    });

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      loadApplications();
      loadJobs();
    });
  </script>
</body>
</html>